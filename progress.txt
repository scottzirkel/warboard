# Army Tracker - Implementation Progress

This file tracks completed features, decisions made, and files changed.
Format follows the Ralph technique.

---

## [patterns-001] Add pattern field to loadout options data structure

**Date:** 2026-01-22

**Decisions:**
- Added `pattern` field to loadout options with two values: "replacement" and "addition"
- "replacement" indicates the choice swaps out the default weapon (mutually exclusive options)
- "addition" indicates the choice adds equipment while keeping base weapon (non-exclusive options)
- All main-weapon type loadouts are "replacement" pattern
- All vexilla type loadouts are "addition" pattern

**Files changed:**
- `data/custodes.json` - Added pattern field to all 8 loadout options across 5 units
  - Custodian Guard: main-weapon (replacement), vexilla (addition)
  - Custodian Wardens: main-weapon (replacement), vexilla (addition)
  - Allarus Custodians: main-weapon (replacement), vexilla (addition)
  - Shield-Captain: main-weapon (replacement)
  - Knight-Centura: loadout (replacement)
- `CLAUDE.md` - Added documentation for Loadout Option data structure and pattern values

**Verification:**
- npm run build passes

---

## [limits-001] Add maxModels field to loadout choice data structure

**Date:** 2026-01-22

**Decisions:**
- Added `maxModels` field to loadout choices to limit how many models can take a specific option
- Field is optional - omit for choices available to all models in the unit
- Used for rules like "1 model can be equipped with a vexilla" â†’ `maxModels: 1`
- Applied to all three vexilla choices across Custodian Guard, Custodian Wardens, and Allarus Custodians

**Files changed:**
- `data/custodes.json` - Added `maxModels: 1` to vexilla choices (3 occurrences)
- `CLAUDE.md` - Added "Loadout Choice Fields" documentation section explaining `id`, `name`, `default`, and `maxModels` fields

**Verification:**
- npm run build passes

---

## [patterns-002] Add paired field to choices for combined loadouts

**Date:** 2026-01-22

**Decisions:**
- Added `paired` field to loadout choices to indicate two items that must be equipped together
- Field is optional - omit for single-item choices
- Used for rules like "1 sentinel blade and 1 praesidium shield" where both items are a single choice
- Added to Custodian Guard "Sentinel Blades + Shield" choice
- Added to Shield-Captain "Sentinel Blade + Shield" choice

**Files changed:**
- `data/custodes.json` - Added `paired: true` to 2 loadout choices
  - Custodian Guard: blades choice (Sentinel Blades + Shield)
  - Shield-Captain: blade choice (Sentinel Blade + Shield)
- `CLAUDE.md` - Added `paired` field documentation to "Loadout Choice Fields" section

**Verification:**
- npm run build passes

---

## [limits-002] Add validation logic for maxModels in weapon count updates

**Date:** 2026-01-22

**Decisions:**
- Added `getChoiceMaxModels(unitId, choiceId)` helper function to retrieve the maxModels limit for a choice
- Updated `updateWeaponCount()` to enforce maxModels constraint when incrementing
- Updated `setWeaponCount()` to enforce maxModels constraint when setting value directly
- The constraint uses the minimum of maxModels and modelCount as the upper limit
- Updated `getWeaponChoices()` to include maxModels in returned choice objects for UI use

**Files changed:**
- `src/main.js` - Added getChoiceMaxModels helper function
- `src/main.js` - Updated updateWeaponCount to enforce maxModels limit
- `src/main.js` - Updated setWeaponCount to enforce maxModels limit
- `src/main.js` - Added maxModels to getWeaponChoices return data

**Verification:**
- npm run build passes

---

## [abilities-001] Add modifiers array to weapons that grant stat bonuses

**Date:** 2026-01-22

**Decisions:**
- Added `modifiers` array field to weapon data structure for weapons that grant stat bonuses
- The Praesidium Shield grants +1 Wound to the bearer (confirmed via Wahapedia)
- Added `source` field to modifiers to identify where the bonus comes from (for tooltip display)
- Modifiers are placed on Sentinel Blade weapons since they are paired with the Praesidium Shield
- Uses existing modifier format: stat, operation, value, scope, plus new source field

**Files changed:**
- `data/custodes.json` - Added modifiers to 4 sentinel blade weapons:
  - Custodian Guard: sentinel-blade (melee) and sentinel-blade-ranged
  - Shield-Captain: sentinel-blade (melee) and sentinel-blade-ranged
  - Each has: `{ "stat": "w", "operation": "add", "value": 1, "scope": "model", "source": "Praesidium Shield" }`
- `CLAUDE.md` - Added "Weapon Modifiers" documentation section with example
- `CLAUDE.md` - Added "Modifier Fields" section documenting stat, operation, value, scope, and source fields

**Verification:**
- npm run build passes

---

## [patterns-003] Update weapon display logic for replacement vs addition patterns

**Date:** 2026-01-22

**Decisions:**
- Added `getLoadoutOptionForChoice(unitId, choiceId)` helper function to retrieve the loadout option for a choice
- Updated `getEquippedWeapons()` to categorize equipped choices by pattern type (replacement vs addition)
- Updated `getEquippedWeaponsWithCounts()` to use pattern-aware logic when calculating weapon counts
- Updated `getEquippedAbilities()` for consistency with the new pattern-aware approach
- Both patterns ultimately filter weapons the same way (by loadoutGroup), but the code now explicitly references the pattern field for clarity and future extensibility

**Files changed:**
- `src/main.js` - Added getLoadoutOptionForChoice helper function
- `src/main.js` - Updated getEquippedWeapons to use pattern-aware grouping
- `src/main.js` - Updated getEquippedWeaponsWithCounts to use pattern map
- `src/main.js` - Updated getEquippedAbilities for consistency

**Verification:**
- npm run build passes

---

## [leader-001] Add eligibleUnits array to leader abilities in data

**Date:** 2026-01-22

**Decisions:**
- Added `eligibleUnits` array field to leader abilities to specify which units a character can attach to
- This is a data-only change that prepares for leader attachment functionality
- Updated all character units with Leader abilities:
  - Shield-Captain: eligibleUnits ["custodian-guard", "custodian-wardens"]
  - Blade Champion: eligibleUnits ["custodian-guard", "custodian-wardens"]
  - Trajann Valoris: eligibleUnits ["custodian-guard", "custodian-wardens"]
  - Knight-Centura: eligibleUnits ["prosecutors", "vigilators", "witchseekers"]
- Did not update Inquisitor Draxus (ally unit) as their leader rules are more complex and out of scope

**Files changed:**
- `data/custodes.json` - Added eligibleUnits array to 4 leader abilities
- `CLAUDE.md` - Added "Leader Ability" and "Leader Ability Fields" documentation sections

**Verification:**
- npm run build passes

---

## [leader-002] Add attachedLeader field to list unit structure

**Date:** 2026-01-22

**Decisions:**
- Added `attachedLeader` field to the list unit data structure
- Field is initialized to `null` when adding new units via `addUnitToList()`
- Field structure is `{ unitIndex: number }` when a leader is attached, or `null` when no leader
- Updated `loadList()` to handle missing `attachedLeader` field on legacy saved lists (sets to `null`)
- This is a data structure change that prepares for leader attachment functionality

**Files changed:**
- `src/main.js` - Added `attachedLeader: null` to unit object in `addUnitToList()`
- `src/main.js` - Added migration logic in `loadList()` for `attachedLeader` field
- `CLAUDE.md` - Updated "List Unit" example with `attachedLeader` field
- `CLAUDE.md` - Added "List Unit Fields" documentation section

**Verification:**
- npm run build passes

---

## [abilities-002] Add isWeaponEquipped helper function

**Date:** 2026-01-22

**Decisions:**
- Added `isWeaponEquipped(listUnit, weapon)` helper function to check if a weapon is equipped
- Function returns `true` for weapons without a `loadoutGroup` (always equipped)
- Function checks `weaponCounts[weapon.loadoutGroup] > 0` for weapons with a loadoutGroup
- Includes fallback support for legacy `loadout` format when `weaponCounts` is empty
- This helper will be used by `collectModifiers` (abilities-003) to include weapon modifiers

**Files changed:**
- `src/main.js` - Added `isWeaponEquipped(listUnit, weapon)` helper function

**Verification:**
- npm run build passes

---

## [abilities-003] Update collectModifiers to include weapon modifiers

**Date:** 2026-01-22

**Decisions:**
- Updated `collectModifiers(unitIndex, stat)` to also check equipped weapons for modifiers
- Uses `isWeaponEquipped(listUnit, weapon)` helper to determine if a weapon's modifiers should apply
- Only collects modifiers where `scope` is `model` or `unit` (consistent with enhancement modifier handling)
- Weapon modifiers are checked after enhancement modifiers
- This enables the Praesidium Shield +1W modifier to apply when Sentinel Blades are equipped

**Files changed:**
- `src/main.js` - Updated `collectModifiers` function to iterate through unit weapons and collect their modifiers

**Verification:**
- npm run build passes

---

## [leader-003] Add getAvailableLeaders function

**Date:** 2026-01-22

**Decisions:**
- Added `getAvailableLeaders(unitIndex)` function to return eligible unattached leaders for a unit
- Function iterates through all units in the current list to find potential leaders
- Filters based on the leader's `eligibleUnits` array (from leader ability data)
- Excludes leaders that are already attached to other units (checks `attachedLeader.unitIndex`)
- Returns array of objects with: `unitIndex`, `unitId`, `name`, `enhancement`
- Placed function near other enhancement/helper functions for logical grouping

**Files changed:**
- `src/main.js` - Added `getAvailableLeaders(unitIndex)` function

**Verification:**
- npm run build passes

---

## [leader-004] Add attachLeader and detachLeader functions

**Date:** 2026-01-22

**Decisions:**
- Added `attachLeader(unitIndex, leaderIndex)` function to attach a leader to a bodyguard unit
- Added `detachLeader(unitIndex)` function to remove the attached leader from a unit
- `attachLeader` first detaches the leader from any unit it's currently attached to (iterates all units)
- `attachLeader` then sets `attachedLeader: { unitIndex: leaderIndex }` on the target unit
- `detachLeader` sets `attachedLeader` to `null`
- Both functions show toast notifications for user feedback
- Functions placed next to `getAvailableLeaders` for logical grouping

**Files changed:**
- `src/main.js` - Added `attachLeader(unitIndex, leaderIndex)` function
- `src/main.js` - Added `detachLeader(unitIndex)` function

**Verification:**
- npm run build passes

---

## [leader-005] Update collectModifiers to include attached leader modifiers

**Date:** 2026-01-22

**Decisions:**
- Updated `collectModifiers(unitIndex, stat)` to check for attached leader and include their enhancement modifiers
- When a unit has `attachedLeader.unitIndex` set, the function retrieves the leader's list unit
- If the leader has an enhancement with modifiers, those modifiers are collected for the bodyguard unit
- Only modifiers with `scope` of `model` or `unit` are included (consistent with existing behavior)
- This enables enhancements like Auric Mantle (+2W) to apply to the attached unit's stat display

**Files changed:**
- `src/main.js` - Added leader enhancement modifier collection in `collectModifiers` function

**Verification:**
- npm run build passes

---

## [leader-006] Add leader attachment dropdown UI to unit cards

**Date:** 2026-01-22

**Decisions:**
- Added `canHaveLeaderAttached(unitIndex)` helper function to determine if a unit can have a leader attached
- Function checks that the unit is not a Character and that at least one leader in the list has this unit in their eligibleUnits
- Added `getAttachedLeaderName(unitIndex)` helper to get the name of the currently attached leader
- Added leader attachment dropdown UI to Build Mode unit cards, placed after the Enhancement Selector
- Dropdown shows "None" option and all available leaders from `getAvailableLeaders()`
- Selecting a leader calls `attachLeader()`, selecting "None" calls `detachLeader()`
- Dropdown shows leader's enhancement name if they have one (e.g., "Shield-Captain (Auric Mantle)")
- Handles edge case where currently attached leader may not be in available list (shows them anyway)

**Files changed:**
- `src/main.js` - Added `canHaveLeaderAttached(unitIndex)` helper function
- `src/main.js` - Added `getAttachedLeaderName(unitIndex)` helper function
- `index.html` - Added Leader Attachment Selector UI to Build Mode unit cards

**Verification:**
- npm run build passes

---

## [leader-007] Update unit display for units with attached leaders

**Date:** 2026-01-22

**Decisions:**
- Added `getCombinedUnitName(unitIndex)` helper function that returns "Unit Name + Leader Name" format when a leader is attached
- Added `getCombinedModelCount(unitIndex)` helper function that sums the unit's model count and the attached leader's model count
- Added `getLeaderWeapons(unitIndex)` helper function to retrieve equipped weapons from the attached leader
- Updated Play Mode army list to show combined unit name and model count for units with attached leaders
- Updated Play Mode unit detail panel header to show combined name
- Added purple "Attached Leader" badge below enhancement badge in detail panel
- Updated "Models" display in damage tracker to show combined model count
- Added leader weapons section in the weapons panel, separated by a purple border with leader name label
- Leader weapons are displayed with same formatting as unit weapons but without modifier calculations

**Files changed:**
- `src/main.js` - Added `getCombinedUnitName(unitIndex)` helper function
- `src/main.js` - Added `getCombinedModelCount(unitIndex)` helper function
- `src/main.js` - Added `getLeaderWeapons(unitIndex)` helper function
- `index.html` - Updated Play Mode army list to use combined name and model count
- `index.html` - Updated Play Mode unit detail panel with combined name, leader badge, and leader weapons

**Verification:**
- npm run build passes

---

## [limits-003] Update UI to show maxModels limits and disable controls

**Date:** 2026-01-22

**Decisions:**
- Added max limit indicator next to weapon choices that have a `maxModels` constraint
- The indicator shows "(max N)" in yellow text next to the choice name
- Added tooltip on the indicator explaining the restriction ("Max N model(s) can take this option")
- Disabled the increment (+) button when the count reaches the maxModels limit
- Button changes appearance (grayed out with cursor-not-allowed) when disabled
- Added tooltip on the disabled button explaining why it's disabled
- Updated the input's max attribute to respect maxModels constraint

**Files changed:**
- `index.html` - Updated weapon loadout UI in Build Mode:
  - Wrapped choice name in a flex container to add limit indicator
  - Added conditional "(max N)" span with yellow text for constrained options
  - Added :disabled binding to + button based on maxModels limit
  - Added :class binding to change button appearance when disabled
  - Added :title binding for tooltip on disabled button
  - Updated input :max to use Math.min(maxModels, modelCount) when constrained

**Verification:**
- npm run build passes

