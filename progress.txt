# Army Tracker - Implementation Progress

This file tracks completed features, decisions made, and files changed.
Format follows the Ralph technique.

---

## [patterns-001] Add pattern field to loadout options data structure

**Date:** 2026-01-22

**Decisions:**
- Added `pattern` field to loadout options with two values: "replacement" and "addition"
- "replacement" indicates the choice swaps out the default weapon (mutually exclusive options)
- "addition" indicates the choice adds equipment while keeping base weapon (non-exclusive options)
- All main-weapon type loadouts are "replacement" pattern
- All vexilla type loadouts are "addition" pattern

**Files changed:**
- `data/custodes.json` - Added pattern field to all 8 loadout options across 5 units
  - Custodian Guard: main-weapon (replacement), vexilla (addition)
  - Custodian Wardens: main-weapon (replacement), vexilla (addition)
  - Allarus Custodians: main-weapon (replacement), vexilla (addition)
  - Shield-Captain: main-weapon (replacement)
  - Knight-Centura: loadout (replacement)
- `CLAUDE.md` - Added documentation for Loadout Option data structure and pattern values

**Verification:**
- npm run build passes

---

## [limits-001] Add maxModels field to loadout choice data structure

**Date:** 2026-01-22

**Decisions:**
- Added `maxModels` field to loadout choices to limit how many models can take a specific option
- Field is optional - omit for choices available to all models in the unit
- Used for rules like "1 model can be equipped with a vexilla" → `maxModels: 1`
- Applied to all three vexilla choices across Custodian Guard, Custodian Wardens, and Allarus Custodians

**Files changed:**
- `data/custodes.json` - Added `maxModels: 1` to vexilla choices (3 occurrences)
- `CLAUDE.md` - Added "Loadout Choice Fields" documentation section explaining `id`, `name`, `default`, and `maxModels` fields

**Verification:**
- npm run build passes

---

## [patterns-002] Add paired field to choices for combined loadouts

**Date:** 2026-01-22

**Decisions:**
- Added `paired` field to loadout choices to indicate two items that must be equipped together
- Field is optional - omit for single-item choices
- Used for rules like "1 sentinel blade and 1 praesidium shield" where both items are a single choice
- Added to Custodian Guard "Sentinel Blades + Shield" choice
- Added to Shield-Captain "Sentinel Blade + Shield" choice

**Files changed:**
- `data/custodes.json` - Added `paired: true` to 2 loadout choices
  - Custodian Guard: blades choice (Sentinel Blades + Shield)
  - Shield-Captain: blade choice (Sentinel Blade + Shield)
- `CLAUDE.md` - Added `paired` field documentation to "Loadout Choice Fields" section

**Verification:**
- npm run build passes

---

## [limits-002] Add validation logic for maxModels in weapon count updates

**Date:** 2026-01-22

**Decisions:**
- Added `getChoiceMaxModels(unitId, choiceId)` helper function to retrieve the maxModels limit for a choice
- Updated `updateWeaponCount()` to enforce maxModels constraint when incrementing
- Updated `setWeaponCount()` to enforce maxModels constraint when setting value directly
- The constraint uses the minimum of maxModels and modelCount as the upper limit
- Updated `getWeaponChoices()` to include maxModels in returned choice objects for UI use

**Files changed:**
- `src/main.js` - Added getChoiceMaxModels helper function
- `src/main.js` - Updated updateWeaponCount to enforce maxModels limit
- `src/main.js` - Updated setWeaponCount to enforce maxModels limit
- `src/main.js` - Added maxModels to getWeaponChoices return data

**Verification:**
- npm run build passes

---

## [abilities-001] Add modifiers array to weapons that grant stat bonuses

**Date:** 2026-01-22

**Decisions:**
- Added `modifiers` array field to weapon data structure for weapons that grant stat bonuses
- The Praesidium Shield grants +1 Wound to the bearer (confirmed via Wahapedia)
- Added `source` field to modifiers to identify where the bonus comes from (for tooltip display)
- Modifiers are placed on Sentinel Blade weapons since they are paired with the Praesidium Shield
- Uses existing modifier format: stat, operation, value, scope, plus new source field

**Files changed:**
- `data/custodes.json` - Added modifiers to 4 sentinel blade weapons:
  - Custodian Guard: sentinel-blade (melee) and sentinel-blade-ranged
  - Shield-Captain: sentinel-blade (melee) and sentinel-blade-ranged
  - Each has: `{ "stat": "w", "operation": "add", "value": 1, "scope": "model", "source": "Praesidium Shield" }`
- `CLAUDE.md` - Added "Weapon Modifiers" documentation section with example
- `CLAUDE.md` - Added "Modifier Fields" section documenting stat, operation, value, scope, and source fields

**Verification:**
- npm run build passes

---

## [patterns-003] Update weapon display logic for replacement vs addition patterns

**Date:** 2026-01-22

**Decisions:**
- Added `getLoadoutOptionForChoice(unitId, choiceId)` helper function to retrieve the loadout option for a choice
- Updated `getEquippedWeapons()` to categorize equipped choices by pattern type (replacement vs addition)
- Updated `getEquippedWeaponsWithCounts()` to use pattern-aware logic when calculating weapon counts
- Updated `getEquippedAbilities()` for consistency with the new pattern-aware approach
- Both patterns ultimately filter weapons the same way (by loadoutGroup), but the code now explicitly references the pattern field for clarity and future extensibility

**Files changed:**
- `src/main.js` - Added getLoadoutOptionForChoice helper function
- `src/main.js` - Updated getEquippedWeapons to use pattern-aware grouping
- `src/main.js` - Updated getEquippedWeaponsWithCounts to use pattern map
- `src/main.js` - Updated getEquippedAbilities for consistency

**Verification:**
- npm run build passes

---

## [leader-001] Add eligibleUnits array to leader abilities in data

**Date:** 2026-01-22

**Decisions:**
- Added `eligibleUnits` array field to leader abilities to specify which units a character can attach to
- This is a data-only change that prepares for leader attachment functionality
- Updated all character units with Leader abilities:
  - Shield-Captain: eligibleUnits ["custodian-guard", "custodian-wardens"]
  - Blade Champion: eligibleUnits ["custodian-guard", "custodian-wardens"]
  - Trajann Valoris: eligibleUnits ["custodian-guard", "custodian-wardens"]
  - Knight-Centura: eligibleUnits ["prosecutors", "vigilators", "witchseekers"]
- Did not update Inquisitor Draxus (ally unit) as their leader rules are more complex and out of scope

**Files changed:**
- `data/custodes.json` - Added eligibleUnits array to 4 leader abilities
- `CLAUDE.md` - Added "Leader Ability" and "Leader Ability Fields" documentation sections

**Verification:**
- npm run build passes

---

## [leader-002] Add attachedLeader field to list unit structure

**Date:** 2026-01-22

**Decisions:**
- Added `attachedLeader` field to the list unit data structure
- Field is initialized to `null` when adding new units via `addUnitToList()`
- Field structure is `{ unitIndex: number }` when a leader is attached, or `null` when no leader
- Updated `loadList()` to handle missing `attachedLeader` field on legacy saved lists (sets to `null`)
- This is a data structure change that prepares for leader attachment functionality

**Files changed:**
- `src/main.js` - Added `attachedLeader: null` to unit object in `addUnitToList()`
- `src/main.js` - Added migration logic in `loadList()` for `attachedLeader` field
- `CLAUDE.md` - Updated "List Unit" example with `attachedLeader` field
- `CLAUDE.md` - Added "List Unit Fields" documentation section

**Verification:**
- npm run build passes

---

## [abilities-002] Add isWeaponEquipped helper function

**Date:** 2026-01-22

**Decisions:**
- Added `isWeaponEquipped(listUnit, weapon)` helper function to check if a weapon is equipped
- Function returns `true` for weapons without a `loadoutGroup` (always equipped)
- Function checks `weaponCounts[weapon.loadoutGroup] > 0` for weapons with a loadoutGroup
- Includes fallback support for legacy `loadout` format when `weaponCounts` is empty
- This helper will be used by `collectModifiers` (abilities-003) to include weapon modifiers

**Files changed:**
- `src/main.js` - Added `isWeaponEquipped(listUnit, weapon)` helper function

**Verification:**
- npm run build passes

---

## [abilities-003] Update collectModifiers to include weapon modifiers

**Date:** 2026-01-22

**Decisions:**
- Updated `collectModifiers(unitIndex, stat)` to also check equipped weapons for modifiers
- Uses `isWeaponEquipped(listUnit, weapon)` helper to determine if a weapon's modifiers should apply
- Only collects modifiers where `scope` is `model` or `unit` (consistent with enhancement modifier handling)
- Weapon modifiers are checked after enhancement modifiers
- This enables the Praesidium Shield +1W modifier to apply when Sentinel Blades are equipped

**Files changed:**
- `src/main.js` - Updated `collectModifiers` function to iterate through unit weapons and collect their modifiers

**Verification:**
- npm run build passes

---

## [leader-003] Add getAvailableLeaders function

**Date:** 2026-01-22

**Decisions:**
- Added `getAvailableLeaders(unitIndex)` function to return eligible unattached leaders for a unit
- Function iterates through all units in the current list to find potential leaders
- Filters based on the leader's `eligibleUnits` array (from leader ability data)
- Excludes leaders that are already attached to other units (checks `attachedLeader.unitIndex`)
- Returns array of objects with: `unitIndex`, `unitId`, `name`, `enhancement`
- Placed function near other enhancement/helper functions for logical grouping

**Files changed:**
- `src/main.js` - Added `getAvailableLeaders(unitIndex)` function

**Verification:**
- npm run build passes

---

## [leader-004] Add attachLeader and detachLeader functions

**Date:** 2026-01-22

**Decisions:**
- Added `attachLeader(unitIndex, leaderIndex)` function to attach a leader to a bodyguard unit
- Added `detachLeader(unitIndex)` function to remove the attached leader from a unit
- `attachLeader` first detaches the leader from any unit it's currently attached to (iterates all units)
- `attachLeader` then sets `attachedLeader: { unitIndex: leaderIndex }` on the target unit
- `detachLeader` sets `attachedLeader` to `null`
- Both functions show toast notifications for user feedback
- Functions placed next to `getAvailableLeaders` for logical grouping

**Files changed:**
- `src/main.js` - Added `attachLeader(unitIndex, leaderIndex)` function
- `src/main.js` - Added `detachLeader(unitIndex)` function

**Verification:**
- npm run build passes

---

## [leader-005] Update collectModifiers to include attached leader modifiers

**Date:** 2026-01-22

**Decisions:**
- Updated `collectModifiers(unitIndex, stat)` to check for attached leader and include their enhancement modifiers
- When a unit has `attachedLeader.unitIndex` set, the function retrieves the leader's list unit
- If the leader has an enhancement with modifiers, those modifiers are collected for the bodyguard unit
- Only modifiers with `scope` of `model` or `unit` are included (consistent with existing behavior)
- This enables enhancements like Auric Mantle (+2W) to apply to the attached unit's stat display

**Files changed:**
- `src/main.js` - Added leader enhancement modifier collection in `collectModifiers` function

**Verification:**
- npm run build passes

---

## [leader-006] Add leader attachment dropdown UI to unit cards

**Date:** 2026-01-22

**Decisions:**
- Added `canHaveLeaderAttached(unitIndex)` helper function to determine if a unit can have a leader attached
- Function checks that the unit is not a Character and that at least one leader in the list has this unit in their eligibleUnits
- Added `getAttachedLeaderName(unitIndex)` helper to get the name of the currently attached leader
- Added leader attachment dropdown UI to Build Mode unit cards, placed after the Enhancement Selector
- Dropdown shows "None" option and all available leaders from `getAvailableLeaders()`
- Selecting a leader calls `attachLeader()`, selecting "None" calls `detachLeader()`
- Dropdown shows leader's enhancement name if they have one (e.g., "Shield-Captain (Auric Mantle)")
- Handles edge case where currently attached leader may not be in available list (shows them anyway)

**Files changed:**
- `src/main.js` - Added `canHaveLeaderAttached(unitIndex)` helper function
- `src/main.js` - Added `getAttachedLeaderName(unitIndex)` helper function
- `index.html` - Added Leader Attachment Selector UI to Build Mode unit cards

**Verification:**
- npm run build passes

---

## [leader-007] Update unit display for units with attached leaders

**Date:** 2026-01-22

**Decisions:**
- Added `getCombinedUnitName(unitIndex)` helper function that returns "Unit Name + Leader Name" format when a leader is attached
- Added `getCombinedModelCount(unitIndex)` helper function that sums the unit's model count and the attached leader's model count
- Added `getLeaderWeapons(unitIndex)` helper function to retrieve equipped weapons from the attached leader
- Updated Play Mode army list to show combined unit name and model count for units with attached leaders
- Updated Play Mode unit detail panel header to show combined name
- Added purple "Attached Leader" badge below enhancement badge in detail panel
- Updated "Models" display in damage tracker to show combined model count
- Added leader weapons section in the weapons panel, separated by a purple border with leader name label
- Leader weapons are displayed with same formatting as unit weapons but without modifier calculations

**Files changed:**
- `src/main.js` - Added `getCombinedUnitName(unitIndex)` helper function
- `src/main.js` - Added `getCombinedModelCount(unitIndex)` helper function
- `src/main.js` - Added `getLeaderWeapons(unitIndex)` helper function
- `index.html` - Updated Play Mode army list to use combined name and model count
- `index.html` - Updated Play Mode unit detail panel with combined name, leader badge, and leader weapons

**Verification:**
- npm run build passes

---

## [limits-003] Update UI to show maxModels limits and disable controls

**Date:** 2026-01-22

**Decisions:**
- Added max limit indicator next to weapon choices that have a `maxModels` constraint
- The indicator shows "(max N)" in yellow text next to the choice name
- Added tooltip on the indicator explaining the restriction ("Max N model(s) can take this option")
- Disabled the increment (+) button when the count reaches the maxModels limit
- Button changes appearance (grayed out with cursor-not-allowed) when disabled
- Added tooltip on the disabled button explaining why it's disabled
- Updated the input's max attribute to respect maxModels constraint

**Files changed:**
- `index.html` - Updated weapon loadout UI in Build Mode:
  - Wrapped choice name in a flex container to add limit indicator
  - Added conditional "(max N)" span with yellow text for constrained options
  - Added :disabled binding to + button based on maxModels limit
  - Added :class binding to change button appearance when disabled
  - Added :title binding for tooltip on disabled button
  - Updated input :max to use Math.min(maxModels, modelCount) when constrained

**Verification:**
- npm run build passes

---

## [leader-010] Add validation rules for leader attachment

**Date:** 2026-01-22

**Decisions:**
- Added `leaderAttachmentErrors` getter that validates leader attachment rules
- Validates that a leader can only attach to one unit (no duplicate attachments)
- Validates that the attached leader exists and has a valid index
- Validates that the leader has the "Leader" ability
- Validates that the target unit is in the leader's `eligibleUnits` array
- Added validation to `attachLeader()` function to prevent invalid attachments at the time of action
- Function now shows error toast and returns early if validation fails
- Merged `leaderAttachmentErrors` into `listErrors` getter so validation runs on save and play mode entry
- The `canPlay` getter already uses `listErrors`, so play mode is blocked if validation fails

**Files changed:**
- `src/main.js` - Added `leaderAttachmentErrors` getter with comprehensive validation
- `src/main.js` - Updated `listErrors` getter to include leader attachment errors
- `src/main.js` - Updated `attachLeader()` function with validation before attachment

**Verification:**
- npm run build passes

---

## [limits-004] Add list validation for maxModels on save and play mode entry

**Date:** 2026-01-22

**Decisions:**
- Added `maxModelsErrors` getter that validates weapon counts against maxModels constraints
- Iterates through all units and their loadout options to check if any choice exceeds its maxModels limit
- Error message format: "{unit name}: {choice name} limited to {maxModels} model(s), but {count} assigned"
- Included `maxModelsErrors` in `listErrors` getter so validation applies everywhere listErrors is used
- Updated `saveList()` to check `listErrors` before saving and show the first error if validation fails
- Play Mode entry was already protected via `canPlay` getter which uses `listErrors`

**Files changed:**
- `src/main.js` - Added `maxModelsErrors` getter for validating maxModels limits
- `src/main.js` - Updated `listErrors` getter to include maxModels errors
- `src/main.js` - Updated `saveList()` to validate and show error before saving

**Verification:**
- npm run build passes

---

## [patterns-004] Update UI labels to indicate pattern type

**Date:** 2026-01-22

**Decisions:**
- Added `getLoadoutOptionsByPattern(unitId)` helper function that groups loadout options by their pattern type
- Returns object with `replacement` and `addition` arrays, each containing full option details
- Updated Build Mode weapon loadout UI to show pattern-specific sections:
  - Replacement options: Blue "⟲ Replace with:" label, standard appearance
  - Addition options: Green "+ Add:" label, green left border to distinguish visually
- Replacement options show paired indicator (⬡) for choices that equip multiple items together
- Addition options continue to show maxModels limits as before
- Updated `getWeaponChoices()` to include `optionPattern` field for consistency

**Files changed:**
- `src/main.js` - Added `getLoadoutOptionsByPattern(unitId)` helper function
- `src/main.js` - Updated `getWeaponChoices()` to include `optionPattern` field
- `index.html` - Restructured weapon loadout UI into two sections:
  - Replacement options section with blue icon and "Replace with:" label
  - Addition options section with green icon, "Add:" label, and green border styling

**Verification:**
- npm run build passes

---

## [patterns-005] Handle paired loadouts equipping both items together

**Date:** 2026-01-22

**Decisions:**
- Added `isPairedChoice(unitId, choiceId)` helper function to check if a loadout choice is paired
- Added `getPairedChoiceName(unitId, choiceId)` helper function to get the display name of a paired choice
- Updated `getEquippedWeaponsWithCounts()` to include `isPaired` flag on returned weapons
- The function now tracks paired status from loadout choice data and attaches it to each weapon
- Updated Play Mode weapon display to show paired indicator (⬡) next to weapons from paired loadouts
- The indicator has a tooltip explaining "Paired loadout (equipped together)"
- Paired loadouts work correctly because weapons share a common `loadoutGroup` (e.g., Sentinel Blade melee and ranged both use "blades")
- The Praesidium Shield bonus is modeled as a modifier on the Sentinel Blade weapons, not a separate equipment item
- Selecting a paired choice automatically equips all items in that loadout group together
- Unselecting (setting count to 0) removes all items in that loadout group

**Files changed:**
- `src/main.js` - Added `isPairedChoice(unitId, choiceId)` helper function
- `src/main.js` - Added `getPairedChoiceName(unitId, choiceId)` helper function
- `src/main.js` - Updated `getEquippedWeaponsWithCounts()` to track and return `isPaired` flag
- `index.html` - Added paired indicator (⬡) to Play Mode weapon display with tooltip

**Verification:**
- npm run build passes

---

## [abilities-004] Update stat display to show weapon modifier sources in tooltips

**Date:** 2026-01-22

**Decisions:**
- Added `getModifierSources(unitIndex, stat)` helper function to collect modifier source names with their values
- Function checks three sources of modifiers: unit's enhancement, equipped weapons, and attached leader's enhancement
- Each source is formatted as "Source Name: +/-value" (e.g., "Praesidium Shield: +1" or "Auric Mantle: +2")
- For weapon modifiers, uses the `source` field if present, otherwise falls back to weapon name
- For attached leader enhancements, appends "(Leader)" to distinguish from unit's own enhancement
- Updated Play Mode stat display to show tooltip on modified stats containing all modifier sources
- Added `cursor-help` class to modified stats to indicate they have additional information
- Multiple modifier sources are separated by newlines in the tooltip

**Files changed:**
- `src/main.js` - Added `getModifierSources(unitIndex, stat)` helper function
- `index.html` - Updated Play Mode stat display with `:title` binding showing modifier sources

**Verification:**
- npm run build passes

---

## [leader-008] Hide attached leaders from main army list display

**Date:** 2026-01-22

**Decisions:**
- Added `isUnitAttachedAsLeader(unitIndex)` helper function to check if a unit is attached as a leader to another unit
- Added `getAttachedToUnitName(unitIndex)` helper function to get the name of the unit a leader is attached to
- Updated Play Mode army list to hide units that are attached as leaders using `x-show="!isUnitAttachedAsLeader(index)"`
- Build Mode still shows all units for editing, but attached leaders have visual indicators:
  - Purple left border (border-l-purple-400) and reduced opacity (opacity-75)
  - Badge showing "→ [unit name]" indicating where the leader is attached
- These visual cues help users understand the unit is attached elsewhere while still allowing editing

**Files changed:**
- `src/main.js` - Added `isUnitAttachedAsLeader(unitIndex)` helper function
- `src/main.js` - Added `getAttachedToUnitName(unitIndex)` helper function
- `index.html` - Updated Play Mode army list to hide attached leaders
- `index.html` - Added visual indicator in Build Mode for attached leaders

**Verification:**
- npm run build passes

---

## [abilities-005] Add wargear abilities section to Quick Reference panel

**Date:** 2026-01-22

**Decisions:**
- Added `getWargearAbilities()` helper function that collects unique weapon stat modifiers from faction data
- Function iterates through all units and their weapons to find modifiers with a `source` field
- Each modifier source is displayed once (deduplicated using a Set)
- Added `getStatDisplayName(stat)` helper to convert stat codes to human-readable names (e.g., "w" → "Wounds")
- Description format: "Bearer gains +N StatName." (e.g., "Bearer gains +1 Wounds.")
- Section uses orange color scheme to distinguish from other reference sections
- Section only shows if wargear abilities exist (via `x-if` template conditional)
- Positioned between Detachment Enhancements and Weapon Keywords sections

**Files changed:**
- `src/main.js` - Added `getWargearAbilities()` helper function
- `src/main.js` - Added `getStatDisplayName(stat)` helper function
- `index.html` - Added Wargear Abilities section to Quick Reference panel

**Verification:**
- npm run build passes

---

## [leader-009] Add separate wound tracking for attached leaders

**Date:** 2026-01-22

**Decisions:**
- Added `leaderCurrentWounds` field to the list unit data structure for tracking leader wounds separately
- Field is initialized to `null` when adding new units (same pattern as `currentWounds`)
- Updated `loadList()` to handle missing `leaderCurrentWounds` field on legacy saved lists
- Added 6 new helper functions for leader wound tracking:
  - `getLeaderMaxWounds(unitIndex)` - returns total max wounds for attached leader
  - `getLeaderWoundsPerModel(unitIndex)` - returns wounds per model for attached leader
  - `getLeaderCurrentWounds(unitIndex)` - returns current wounds for attached leader (or max if null)
  - `getLeaderModelsAlive(unitIndex)` - returns number of leader models still alive
  - `getCurrentLeaderModelWounds(unitIndex)` - returns wounds remaining on current leader model
  - `adjustLeaderWounds(unitIndex, delta)` - adjusts leader wounds by delta value
- Updated Damage Tracker UI to show two separate wound pools when a leader is attached:
  - Unit wounds section with gray background, showing unit name and unit-specific controls
  - Leader wounds section with purple border/background, showing leader name and leader-specific controls
- Each wound pool has its own +/- buttons and current model wound indicators
- Total models alive display now sums both unit and leader models alive
- Leader wound indicators use purple color scheme to match other leader UI elements

**Files changed:**
- `src/main.js` - Added `leaderCurrentWounds: null` to unit object in `addUnitToList()`
- `src/main.js` - Added migration logic in `loadList()` for `leaderCurrentWounds` field
- `src/main.js` - Added 6 new leader wound tracking helper functions
- `index.html` - Restructured Damage Tracker UI to show separate unit and leader wound pools
- `CLAUDE.md` - Updated List Unit example with `leaderCurrentWounds` field
- `CLAUDE.md` - Added `leaderCurrentWounds` to List Unit Fields documentation

**Verification:**
- npm run build passes

---

## [mixed-001] Group weapons by loadout choice in Play Mode unit display

**Date:** 2026-01-22

**Decisions:**
- Added `getWeaponsByLoadoutGroup(listUnit)` helper function that groups weapons by their loadoutGroup
- Function returns an array of group objects with: id, name, modelCount, isPaired, and weapons array
- Groups are sorted with _default (Standard Equipment) first, then by model count descending
- Updated Play Mode weapons display to show weapons in distinct visual groups
- Each group has a header showing the model count prefix (e.g., "3×") and the loadout name
- Groups use a subtle background color (bg-gray-600/50) with bottom border to visually separate them
- Paired loadout indicator (⬡) is shown at the group level instead of per-weapon
- This change prepares the UI structure for future features (collapsible groups, ranged/melee sections)

**Files changed:**
- `src/main.js` - Added `getWeaponsByLoadoutGroup(listUnit)` helper function
- `index.html` - Updated Play Mode weapons section to use grouped display with visual separation

**Verification:**
- npm run build passes

---

## [mixed-002] Separate ranged and melee weapon sections within each loadout group

**Date:** 2026-01-22

**Decisions:**
- Updated `getWeaponsByLoadoutGroup(listUnit)` to include separate `rangedWeapons` and `meleeWeapons` arrays
- Each loadout group now returns: id, name, modelCount, isPaired, weapons (all), rangedWeapons, meleeWeapons
- Updated Play Mode UI to display Ranged and Melee subsections within each loadout group
- Ranged subsection has blue color scheme (text-blue-400, border-blue-500/30)
- Melee subsection has red color scheme (text-red-400, border-red-500/30)
- Subsections use left border indent to create visual hierarchy: Loadout > Ranged/Melee > Weapon stats
- Subsections only display if the loadout group has weapons of that type
- This provides clearer organization when loadout groups have both ranged and melee weapons

**Files changed:**
- `src/main.js` - Updated `getWeaponsByLoadoutGroup` to add rangedWeapons and meleeWeapons arrays
- `index.html` - Restructured Play Mode weapons display to show Ranged/Melee subsections

**Verification:**
- npm run build passes

---

## [mixed-003] Make loadout groups collapsible in Play Mode

**Date:** 2026-01-22

**Decisions:**
- Added `collapsedLoadoutGroups` object to `gameState` to track collapsed state per unit and group
- State structure is `{ unitIndex: { groupId: true } }` where true means collapsed
- Added `isLoadoutGroupCollapsed(unitIndex, groupId)` helper function to check if a group is collapsed
- Added `toggleLoadoutGroupCollapsed(unitIndex, groupId)` helper function to toggle collapse state
- Updated Play Mode loadout group UI to make headers clickable with hover effect
- Added chevron icon that rotates 90° when collapsed (points right when collapsed, down when expanded)
- Used Alpine.js `x-collapse` directive for smooth animated transitions
- Collapsed state shows just the header (e.g., "▶ 3× Guardian Spear")
- Expanded state shows the full ranged/melee subsections
- Groups start expanded by default (collapsed state defaults to falsy)

**Files changed:**
- `src/main.js` - Added `collapsedLoadoutGroups` to gameState
- `src/main.js` - Added `isLoadoutGroupCollapsed(unitIndex, groupId)` helper function
- `src/main.js` - Added `toggleLoadoutGroupCollapsed(unitIndex, groupId)` helper function
- `index.html` - Updated loadout group UI with collapsible headers and chevron icons

**Verification:**
- npm run build passes

---

## [mixed-004] Track activation state per loadout group

**Date:** 2026-01-22

**Decisions:**
- Added `activatedLoadoutGroups` object to `gameState` to track which loadout groups have activated this round
- State structure is `{ unitIndex: { groupId: true } }` where true means activated
- Added `isLoadoutGroupActivated(unitIndex, groupId)` helper function to check activation state
- Added `toggleLoadoutGroupActivated(unitIndex, groupId)` helper function to toggle activation
- When a group is marked as activated, it automatically collapses to indicate those models are done
- Added `resetActivationState()` helper function to clear all activation states
- Added `$watch` on `gameState.battleRound` in `init()` to automatically reset activation state when battle round changes
- Visual distinction between collapsed-by-user and collapsed-as-activated:
  - Activated groups have green background (bg-green-900/40) with green ring outline
  - Activated groups show green text colors for model count and loadout name
  - Non-activated groups retain original gray styling
- Added "Act" button on each loadout group header to toggle activation state
- Button shows checkmark (✓) when activated, "Act" when not activated
- Clicking the activate button uses @click.stop to prevent triggering collapse toggle

**Files changed:**
- `src/main.js` - Added `activatedLoadoutGroups` to gameState
- `src/main.js` - Added `isLoadoutGroupActivated(unitIndex, groupId)` helper function
- `src/main.js` - Added `toggleLoadoutGroupActivated(unitIndex, groupId)` helper function
- `src/main.js` - Added `resetActivationState()` helper function
- `src/main.js` - Added `$watch` in init() to reset activation on battle round change
- `index.html` - Updated loadout group styling with conditional classes for activated state
- `index.html` - Added activation toggle button to loadout group headers

**Verification:**
- npm run build passes

---

## [tyranids-001] Create tyranids.json with faction metadata and army rules

**Date:** 2026-01-22

**Decisions:**
- Created new `data/tyranids.json` file with the same structure as `custodes.json`
- Added faction name "Tyranids" and lastUpdated "2026-01"
- Army rules include Synapse with 6" range that gives 3D6 Battle-shock tests
- Army rules include Shadow in the Warp as once-per-battle ability forcing enemy Battle-shock tests
- Both abilities reference SYNAPSE keyword in their rules
- Added `range: 6` to Synapse for potential programmatic use
- Added `oncePerBattle: true` to Shadow in the Warp for tracking
- Added standard weapon keywords section for reference
- Units array starts empty (will be populated by subsequent tasks)
- Detachments object starts empty (will be populated by subsequent tasks)

**Files changed:**
- `data/tyranids.json` - Created new faction data file with:
  - Faction metadata (faction, lastUpdated)
  - armyRules.synapse with name, description, range, keywords
  - armyRules.shadow_in_the_warp with name, description, oncePerBattle, keywords
  - Empty units array placeholder
  - Empty detachments object placeholder
  - weaponKeywords for common abilities
  - Empty allies and glossary placeholders

**Verification:**
- npm run build passes
- JSON validates successfully

---

## [tyranids-002] Add Termagants battleline unit to tyranids.json

**Date:** 2026-01-22

**Decisions:**
- Added Termagants as the first Tyranid battleline unit
- Points costs: 60 points for 10 models, 120 points for 20 models (per Munitorum Field Manual)
- Stats match 10th edition datasheet: M6 T3 SV5+ W1 LD8+ OC2
- No invulnerable save (set to null)
- Included three ranged weapon options via loadoutOptions with "replacement" pattern:
  - Fleshborer (default): 18" A1 BS4+ S5 AP0 D1, Assault
  - Termagant Devourer: 18" A2 BS4+ S4 AP0 D1
  - Termagant Spinefists: 12" A2 BS4+ S3 AP0 D1, Assault, Pistol, Twin-linked
- Included melee weapon: Chitinous Claws and Teeth (A1 WS4+ S3 AP0 D1)
- Added Skulking Horrors ability: reactive D6" move when enemy ends movement within 9"
- Keywords: Infantry, Battleline, Great Devourer, Endless Multitude, Termagants

**Files changed:**
- `data/tyranids.json` - Added Termagants unit to the units array with:
  - Full unit stats and points
  - 4 weapon profiles (3 ranged options, 1 melee)
  - loadoutOptions for ranged weapon replacement choices
  - Skulking Horrors ability
  - Appropriate keywords including Battleline and Endless Multitude

**Verification:**
- npm run build passes

