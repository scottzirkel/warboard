# Army Tracker - Implementation Progress

This file tracks completed features, decisions made, and files changed.
Format follows the Ralph technique.

---

## [patterns-001] Add pattern field to loadout options data structure

**Date:** 2026-01-22

**Decisions:**
- Added `pattern` field to loadout options with two values: "replacement" and "addition"
- "replacement" indicates the choice swaps out the default weapon (mutually exclusive options)
- "addition" indicates the choice adds equipment while keeping base weapon (non-exclusive options)
- All main-weapon type loadouts are "replacement" pattern
- All vexilla type loadouts are "addition" pattern

**Files changed:**
- `data/custodes.json` - Added pattern field to all 8 loadout options across 5 units
  - Custodian Guard: main-weapon (replacement), vexilla (addition)
  - Custodian Wardens: main-weapon (replacement), vexilla (addition)
  - Allarus Custodians: main-weapon (replacement), vexilla (addition)
  - Shield-Captain: main-weapon (replacement)
  - Knight-Centura: loadout (replacement)
- `CLAUDE.md` - Added documentation for Loadout Option data structure and pattern values

**Verification:**
- npm run build passes

---

## [limits-001] Add maxModels field to loadout choice data structure

**Date:** 2026-01-22

**Decisions:**
- Added `maxModels` field to loadout choices to limit how many models can take a specific option
- Field is optional - omit for choices available to all models in the unit
- Used for rules like "1 model can be equipped with a vexilla" â†’ `maxModels: 1`
- Applied to all three vexilla choices across Custodian Guard, Custodian Wardens, and Allarus Custodians

**Files changed:**
- `data/custodes.json` - Added `maxModels: 1` to vexilla choices (3 occurrences)
- `CLAUDE.md` - Added "Loadout Choice Fields" documentation section explaining `id`, `name`, `default`, and `maxModels` fields

**Verification:**
- npm run build passes

---

## [patterns-002] Add paired field to choices for combined loadouts

**Date:** 2026-01-22

**Decisions:**
- Added `paired` field to loadout choices to indicate two items that must be equipped together
- Field is optional - omit for single-item choices
- Used for rules like "1 sentinel blade and 1 praesidium shield" where both items are a single choice
- Added to Custodian Guard "Sentinel Blades + Shield" choice
- Added to Shield-Captain "Sentinel Blade + Shield" choice

**Files changed:**
- `data/custodes.json` - Added `paired: true` to 2 loadout choices
  - Custodian Guard: blades choice (Sentinel Blades + Shield)
  - Shield-Captain: blade choice (Sentinel Blade + Shield)
- `CLAUDE.md` - Added `paired` field documentation to "Loadout Choice Fields" section

**Verification:**
- npm run build passes

---

## [limits-002] Add validation logic for maxModels in weapon count updates

**Date:** 2026-01-22

**Decisions:**
- Added `getChoiceMaxModels(unitId, choiceId)` helper function to retrieve the maxModels limit for a choice
- Updated `updateWeaponCount()` to enforce maxModels constraint when incrementing
- Updated `setWeaponCount()` to enforce maxModels constraint when setting value directly
- The constraint uses the minimum of maxModels and modelCount as the upper limit
- Updated `getWeaponChoices()` to include maxModels in returned choice objects for UI use

**Files changed:**
- `src/main.js` - Added getChoiceMaxModels helper function
- `src/main.js` - Updated updateWeaponCount to enforce maxModels limit
- `src/main.js` - Updated setWeaponCount to enforce maxModels limit
- `src/main.js` - Added maxModels to getWeaponChoices return data

**Verification:**
- npm run build passes

---

## [abilities-001] Add modifiers array to weapons that grant stat bonuses

**Date:** 2026-01-22

**Decisions:**
- Added `modifiers` array field to weapon data structure for weapons that grant stat bonuses
- The Praesidium Shield grants +1 Wound to the bearer (confirmed via Wahapedia)
- Added `source` field to modifiers to identify where the bonus comes from (for tooltip display)
- Modifiers are placed on Sentinel Blade weapons since they are paired with the Praesidium Shield
- Uses existing modifier format: stat, operation, value, scope, plus new source field

**Files changed:**
- `data/custodes.json` - Added modifiers to 4 sentinel blade weapons:
  - Custodian Guard: sentinel-blade (melee) and sentinel-blade-ranged
  - Shield-Captain: sentinel-blade (melee) and sentinel-blade-ranged
  - Each has: `{ "stat": "w", "operation": "add", "value": 1, "scope": "model", "source": "Praesidium Shield" }`
- `CLAUDE.md` - Added "Weapon Modifiers" documentation section with example
- `CLAUDE.md` - Added "Modifier Fields" section documenting stat, operation, value, scope, and source fields

**Verification:**
- npm run build passes

---

## [patterns-003] Update weapon display logic for replacement vs addition patterns

**Date:** 2026-01-22

**Decisions:**
- Added `getLoadoutOptionForChoice(unitId, choiceId)` helper function to retrieve the loadout option for a choice
- Updated `getEquippedWeapons()` to categorize equipped choices by pattern type (replacement vs addition)
- Updated `getEquippedWeaponsWithCounts()` to use pattern-aware logic when calculating weapon counts
- Updated `getEquippedAbilities()` for consistency with the new pattern-aware approach
- Both patterns ultimately filter weapons the same way (by loadoutGroup), but the code now explicitly references the pattern field for clarity and future extensibility

**Files changed:**
- `src/main.js` - Added getLoadoutOptionForChoice helper function
- `src/main.js` - Updated getEquippedWeapons to use pattern-aware grouping
- `src/main.js` - Updated getEquippedWeaponsWithCounts to use pattern map
- `src/main.js` - Updated getEquippedAbilities for consistency

**Verification:**
- npm run build passes

---

## [leader-001] Add eligibleUnits array to leader abilities in data

**Date:** 2026-01-22

**Decisions:**
- Added `eligibleUnits` array field to leader abilities to specify which units a character can attach to
- This is a data-only change that prepares for leader attachment functionality
- Updated all character units with Leader abilities:
  - Shield-Captain: eligibleUnits ["custodian-guard", "custodian-wardens"]
  - Blade Champion: eligibleUnits ["custodian-guard", "custodian-wardens"]
  - Trajann Valoris: eligibleUnits ["custodian-guard", "custodian-wardens"]
  - Knight-Centura: eligibleUnits ["prosecutors", "vigilators", "witchseekers"]
- Did not update Inquisitor Draxus (ally unit) as their leader rules are more complex and out of scope

**Files changed:**
- `data/custodes.json` - Added eligibleUnits array to 4 leader abilities
- `CLAUDE.md` - Added "Leader Ability" and "Leader Ability Fields" documentation sections

**Verification:**
- npm run build passes

---

## [leader-002] Add attachedLeader field to list unit structure

**Date:** 2026-01-22

**Decisions:**
- Added `attachedLeader` field to the list unit data structure
- Field is initialized to `null` when adding new units via `addUnitToList()`
- Field structure is `{ unitIndex: number }` when a leader is attached, or `null` when no leader
- Updated `loadList()` to handle missing `attachedLeader` field on legacy saved lists (sets to `null`)
- This is a data structure change that prepares for leader attachment functionality

**Files changed:**
- `src/main.js` - Added `attachedLeader: null` to unit object in `addUnitToList()`
- `src/main.js` - Added migration logic in `loadList()` for `attachedLeader` field
- `CLAUDE.md` - Updated "List Unit" example with `attachedLeader` field
- `CLAUDE.md` - Added "List Unit Fields" documentation section

**Verification:**
- npm run build passes

