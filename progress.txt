# Army Tracker - Implementation Progress

This file tracks completed features, decisions made, and files changed.
Format follows the Ralph technique.

---

## [patterns-001] Add pattern field to loadout options data structure

**Date:** 2026-01-22

**Decisions:**
- Added `pattern` field to loadout options with two values: "replacement" and "addition"
- "replacement" indicates the choice swaps out the default weapon (mutually exclusive options)
- "addition" indicates the choice adds equipment while keeping base weapon (non-exclusive options)
- All main-weapon type loadouts are "replacement" pattern
- All vexilla type loadouts are "addition" pattern

**Files changed:**
- `data/custodes.json` - Added pattern field to all 8 loadout options across 5 units
  - Custodian Guard: main-weapon (replacement), vexilla (addition)
  - Custodian Wardens: main-weapon (replacement), vexilla (addition)
  - Allarus Custodians: main-weapon (replacement), vexilla (addition)
  - Shield-Captain: main-weapon (replacement)
  - Knight-Centura: loadout (replacement)
- `CLAUDE.md` - Added documentation for Loadout Option data structure and pattern values

**Verification:**
- npm run build passes

---

## [limits-001] Add maxModels field to loadout choice data structure

**Date:** 2026-01-22

**Decisions:**
- Added `maxModels` field to loadout choices to limit how many models can take a specific option
- Field is optional - omit for choices available to all models in the unit
- Used for rules like "1 model can be equipped with a vexilla" → `maxModels: 1`
- Applied to all three vexilla choices across Custodian Guard, Custodian Wardens, and Allarus Custodians

**Files changed:**
- `data/custodes.json` - Added `maxModels: 1` to vexilla choices (3 occurrences)
- `CLAUDE.md` - Added "Loadout Choice Fields" documentation section explaining `id`, `name`, `default`, and `maxModels` fields

**Verification:**
- npm run build passes

---

## [patterns-002] Add paired field to choices for combined loadouts

**Date:** 2026-01-22

**Decisions:**
- Added `paired` field to loadout choices to indicate two items that must be equipped together
- Field is optional - omit for single-item choices
- Used for rules like "1 sentinel blade and 1 praesidium shield" where both items are a single choice
- Added to Custodian Guard "Sentinel Blades + Shield" choice
- Added to Shield-Captain "Sentinel Blade + Shield" choice

**Files changed:**
- `data/custodes.json` - Added `paired: true` to 2 loadout choices
  - Custodian Guard: blades choice (Sentinel Blades + Shield)
  - Shield-Captain: blade choice (Sentinel Blade + Shield)
- `CLAUDE.md` - Added `paired` field documentation to "Loadout Choice Fields" section

**Verification:**
- npm run build passes

---

## [limits-002] Add validation logic for maxModels in weapon count updates

**Date:** 2026-01-22

**Decisions:**
- Added `getChoiceMaxModels(unitId, choiceId)` helper function to retrieve the maxModels limit for a choice
- Updated `updateWeaponCount()` to enforce maxModels constraint when incrementing
- Updated `setWeaponCount()` to enforce maxModels constraint when setting value directly
- The constraint uses the minimum of maxModels and modelCount as the upper limit
- Updated `getWeaponChoices()` to include maxModels in returned choice objects for UI use

**Files changed:**
- `src/main.js` - Added getChoiceMaxModels helper function
- `src/main.js` - Updated updateWeaponCount to enforce maxModels limit
- `src/main.js` - Updated setWeaponCount to enforce maxModels limit
- `src/main.js` - Added maxModels to getWeaponChoices return data

**Verification:**
- npm run build passes

---

## [abilities-001] Add modifiers array to weapons that grant stat bonuses

**Date:** 2026-01-22

**Decisions:**
- Added `modifiers` array field to weapon data structure for weapons that grant stat bonuses
- The Praesidium Shield grants +1 Wound to the bearer (confirmed via Wahapedia)
- Added `source` field to modifiers to identify where the bonus comes from (for tooltip display)
- Modifiers are placed on Sentinel Blade weapons since they are paired with the Praesidium Shield
- Uses existing modifier format: stat, operation, value, scope, plus new source field

**Files changed:**
- `data/custodes.json` - Added modifiers to 4 sentinel blade weapons:
  - Custodian Guard: sentinel-blade (melee) and sentinel-blade-ranged
  - Shield-Captain: sentinel-blade (melee) and sentinel-blade-ranged
  - Each has: `{ "stat": "w", "operation": "add", "value": 1, "scope": "model", "source": "Praesidium Shield" }`
- `CLAUDE.md` - Added "Weapon Modifiers" documentation section with example
- `CLAUDE.md` - Added "Modifier Fields" section documenting stat, operation, value, scope, and source fields

**Verification:**
- npm run build passes

---

## [patterns-003] Update weapon display logic for replacement vs addition patterns

**Date:** 2026-01-22

**Decisions:**
- Added `getLoadoutOptionForChoice(unitId, choiceId)` helper function to retrieve the loadout option for a choice
- Updated `getEquippedWeapons()` to categorize equipped choices by pattern type (replacement vs addition)
- Updated `getEquippedWeaponsWithCounts()` to use pattern-aware logic when calculating weapon counts
- Updated `getEquippedAbilities()` for consistency with the new pattern-aware approach
- Both patterns ultimately filter weapons the same way (by loadoutGroup), but the code now explicitly references the pattern field for clarity and future extensibility

**Files changed:**
- `src/main.js` - Added getLoadoutOptionForChoice helper function
- `src/main.js` - Updated getEquippedWeapons to use pattern-aware grouping
- `src/main.js` - Updated getEquippedWeaponsWithCounts to use pattern map
- `src/main.js` - Updated getEquippedAbilities for consistency

**Verification:**
- npm run build passes

---

## [leader-001] Add eligibleUnits array to leader abilities in data

**Date:** 2026-01-22

**Decisions:**
- Added `eligibleUnits` array field to leader abilities to specify which units a character can attach to
- This is a data-only change that prepares for leader attachment functionality
- Updated all character units with Leader abilities:
  - Shield-Captain: eligibleUnits ["custodian-guard", "custodian-wardens"]
  - Blade Champion: eligibleUnits ["custodian-guard", "custodian-wardens"]
  - Trajann Valoris: eligibleUnits ["custodian-guard", "custodian-wardens"]
  - Knight-Centura: eligibleUnits ["prosecutors", "vigilators", "witchseekers"]
- Did not update Inquisitor Draxus (ally unit) as their leader rules are more complex and out of scope

**Files changed:**
- `data/custodes.json` - Added eligibleUnits array to 4 leader abilities
- `CLAUDE.md` - Added "Leader Ability" and "Leader Ability Fields" documentation sections

**Verification:**
- npm run build passes

---

## [leader-002] Add attachedLeader field to list unit structure

**Date:** 2026-01-22

**Decisions:**
- Added `attachedLeader` field to the list unit data structure
- Field is initialized to `null` when adding new units via `addUnitToList()`
- Field structure is `{ unitIndex: number }` when a leader is attached, or `null` when no leader
- Updated `loadList()` to handle missing `attachedLeader` field on legacy saved lists (sets to `null`)
- This is a data structure change that prepares for leader attachment functionality

**Files changed:**
- `src/main.js` - Added `attachedLeader: null` to unit object in `addUnitToList()`
- `src/main.js` - Added migration logic in `loadList()` for `attachedLeader` field
- `CLAUDE.md` - Updated "List Unit" example with `attachedLeader` field
- `CLAUDE.md` - Added "List Unit Fields" documentation section

**Verification:**
- npm run build passes

---

## [abilities-002] Add isWeaponEquipped helper function

**Date:** 2026-01-22

**Decisions:**
- Added `isWeaponEquipped(listUnit, weapon)` helper function to check if a weapon is equipped
- Function returns `true` for weapons without a `loadoutGroup` (always equipped)
- Function checks `weaponCounts[weapon.loadoutGroup] > 0` for weapons with a loadoutGroup
- Includes fallback support for legacy `loadout` format when `weaponCounts` is empty
- This helper will be used by `collectModifiers` (abilities-003) to include weapon modifiers

**Files changed:**
- `src/main.js` - Added `isWeaponEquipped(listUnit, weapon)` helper function

**Verification:**
- npm run build passes

---

## [abilities-003] Update collectModifiers to include weapon modifiers

**Date:** 2026-01-22

**Decisions:**
- Updated `collectModifiers(unitIndex, stat)` to also check equipped weapons for modifiers
- Uses `isWeaponEquipped(listUnit, weapon)` helper to determine if a weapon's modifiers should apply
- Only collects modifiers where `scope` is `model` or `unit` (consistent with enhancement modifier handling)
- Weapon modifiers are checked after enhancement modifiers
- This enables the Praesidium Shield +1W modifier to apply when Sentinel Blades are equipped

**Files changed:**
- `src/main.js` - Updated `collectModifiers` function to iterate through unit weapons and collect their modifiers

**Verification:**
- npm run build passes

---

## [leader-003] Add getAvailableLeaders function

**Date:** 2026-01-22

**Decisions:**
- Added `getAvailableLeaders(unitIndex)` function to return eligible unattached leaders for a unit
- Function iterates through all units in the current list to find potential leaders
- Filters based on the leader's `eligibleUnits` array (from leader ability data)
- Excludes leaders that are already attached to other units (checks `attachedLeader.unitIndex`)
- Returns array of objects with: `unitIndex`, `unitId`, `name`, `enhancement`
- Placed function near other enhancement/helper functions for logical grouping

**Files changed:**
- `src/main.js` - Added `getAvailableLeaders(unitIndex)` function

**Verification:**
- npm run build passes

---

## [leader-004] Add attachLeader and detachLeader functions

**Date:** 2026-01-22

**Decisions:**
- Added `attachLeader(unitIndex, leaderIndex)` function to attach a leader to a bodyguard unit
- Added `detachLeader(unitIndex)` function to remove the attached leader from a unit
- `attachLeader` first detaches the leader from any unit it's currently attached to (iterates all units)
- `attachLeader` then sets `attachedLeader: { unitIndex: leaderIndex }` on the target unit
- `detachLeader` sets `attachedLeader` to `null`
- Both functions show toast notifications for user feedback
- Functions placed next to `getAvailableLeaders` for logical grouping

**Files changed:**
- `src/main.js` - Added `attachLeader(unitIndex, leaderIndex)` function
- `src/main.js` - Added `detachLeader(unitIndex)` function

**Verification:**
- npm run build passes

---

## [leader-005] Update collectModifiers to include attached leader modifiers

**Date:** 2026-01-22

**Decisions:**
- Updated `collectModifiers(unitIndex, stat)` to check for attached leader and include their enhancement modifiers
- When a unit has `attachedLeader.unitIndex` set, the function retrieves the leader's list unit
- If the leader has an enhancement with modifiers, those modifiers are collected for the bodyguard unit
- Only modifiers with `scope` of `model` or `unit` are included (consistent with existing behavior)
- This enables enhancements like Auric Mantle (+2W) to apply to the attached unit's stat display

**Files changed:**
- `src/main.js` - Added leader enhancement modifier collection in `collectModifiers` function

**Verification:**
- npm run build passes

---

## [leader-006] Add leader attachment dropdown UI to unit cards

**Date:** 2026-01-22

**Decisions:**
- Added `canHaveLeaderAttached(unitIndex)` helper function to determine if a unit can have a leader attached
- Function checks that the unit is not a Character and that at least one leader in the list has this unit in their eligibleUnits
- Added `getAttachedLeaderName(unitIndex)` helper to get the name of the currently attached leader
- Added leader attachment dropdown UI to Build Mode unit cards, placed after the Enhancement Selector
- Dropdown shows "None" option and all available leaders from `getAvailableLeaders()`
- Selecting a leader calls `attachLeader()`, selecting "None" calls `detachLeader()`
- Dropdown shows leader's enhancement name if they have one (e.g., "Shield-Captain (Auric Mantle)")
- Handles edge case where currently attached leader may not be in available list (shows them anyway)

**Files changed:**
- `src/main.js` - Added `canHaveLeaderAttached(unitIndex)` helper function
- `src/main.js` - Added `getAttachedLeaderName(unitIndex)` helper function
- `index.html` - Added Leader Attachment Selector UI to Build Mode unit cards

**Verification:**
- npm run build passes

---

## [leader-007] Update unit display for units with attached leaders

**Date:** 2026-01-22

**Decisions:**
- Added `getCombinedUnitName(unitIndex)` helper function that returns "Unit Name + Leader Name" format when a leader is attached
- Added `getCombinedModelCount(unitIndex)` helper function that sums the unit's model count and the attached leader's model count
- Added `getLeaderWeapons(unitIndex)` helper function to retrieve equipped weapons from the attached leader
- Updated Play Mode army list to show combined unit name and model count for units with attached leaders
- Updated Play Mode unit detail panel header to show combined name
- Added purple "Attached Leader" badge below enhancement badge in detail panel
- Updated "Models" display in damage tracker to show combined model count
- Added leader weapons section in the weapons panel, separated by a purple border with leader name label
- Leader weapons are displayed with same formatting as unit weapons but without modifier calculations

**Files changed:**
- `src/main.js` - Added `getCombinedUnitName(unitIndex)` helper function
- `src/main.js` - Added `getCombinedModelCount(unitIndex)` helper function
- `src/main.js` - Added `getLeaderWeapons(unitIndex)` helper function
- `index.html` - Updated Play Mode army list to use combined name and model count
- `index.html` - Updated Play Mode unit detail panel with combined name, leader badge, and leader weapons

**Verification:**
- npm run build passes

---

## [limits-003] Update UI to show maxModels limits and disable controls

**Date:** 2026-01-22

**Decisions:**
- Added max limit indicator next to weapon choices that have a `maxModels` constraint
- The indicator shows "(max N)" in yellow text next to the choice name
- Added tooltip on the indicator explaining the restriction ("Max N model(s) can take this option")
- Disabled the increment (+) button when the count reaches the maxModels limit
- Button changes appearance (grayed out with cursor-not-allowed) when disabled
- Added tooltip on the disabled button explaining why it's disabled
- Updated the input's max attribute to respect maxModels constraint

**Files changed:**
- `index.html` - Updated weapon loadout UI in Build Mode:
  - Wrapped choice name in a flex container to add limit indicator
  - Added conditional "(max N)" span with yellow text for constrained options
  - Added :disabled binding to + button based on maxModels limit
  - Added :class binding to change button appearance when disabled
  - Added :title binding for tooltip on disabled button
  - Updated input :max to use Math.min(maxModels, modelCount) when constrained

**Verification:**
- npm run build passes

---

## [leader-010] Add validation rules for leader attachment

**Date:** 2026-01-22

**Decisions:**
- Added `leaderAttachmentErrors` getter that validates leader attachment rules
- Validates that a leader can only attach to one unit (no duplicate attachments)
- Validates that the attached leader exists and has a valid index
- Validates that the leader has the "Leader" ability
- Validates that the target unit is in the leader's `eligibleUnits` array
- Added validation to `attachLeader()` function to prevent invalid attachments at the time of action
- Function now shows error toast and returns early if validation fails
- Merged `leaderAttachmentErrors` into `listErrors` getter so validation runs on save and play mode entry
- The `canPlay` getter already uses `listErrors`, so play mode is blocked if validation fails

**Files changed:**
- `src/main.js` - Added `leaderAttachmentErrors` getter with comprehensive validation
- `src/main.js` - Updated `listErrors` getter to include leader attachment errors
- `src/main.js` - Updated `attachLeader()` function with validation before attachment

**Verification:**
- npm run build passes

---

## [limits-004] Add list validation for maxModels on save and play mode entry

**Date:** 2026-01-22

**Decisions:**
- Added `maxModelsErrors` getter that validates weapon counts against maxModels constraints
- Iterates through all units and their loadout options to check if any choice exceeds its maxModels limit
- Error message format: "{unit name}: {choice name} limited to {maxModels} model(s), but {count} assigned"
- Included `maxModelsErrors` in `listErrors` getter so validation applies everywhere listErrors is used
- Updated `saveList()` to check `listErrors` before saving and show the first error if validation fails
- Play Mode entry was already protected via `canPlay` getter which uses `listErrors`

**Files changed:**
- `src/main.js` - Added `maxModelsErrors` getter for validating maxModels limits
- `src/main.js` - Updated `listErrors` getter to include maxModels errors
- `src/main.js` - Updated `saveList()` to validate and show error before saving

**Verification:**
- npm run build passes

---

## [patterns-004] Update UI labels to indicate pattern type

**Date:** 2026-01-22

**Decisions:**
- Added `getLoadoutOptionsByPattern(unitId)` helper function that groups loadout options by their pattern type
- Returns object with `replacement` and `addition` arrays, each containing full option details
- Updated Build Mode weapon loadout UI to show pattern-specific sections:
  - Replacement options: Blue "⟲ Replace with:" label, standard appearance
  - Addition options: Green "+ Add:" label, green left border to distinguish visually
- Replacement options show paired indicator (⬡) for choices that equip multiple items together
- Addition options continue to show maxModels limits as before
- Updated `getWeaponChoices()` to include `optionPattern` field for consistency

**Files changed:**
- `src/main.js` - Added `getLoadoutOptionsByPattern(unitId)` helper function
- `src/main.js` - Updated `getWeaponChoices()` to include `optionPattern` field
- `index.html` - Restructured weapon loadout UI into two sections:
  - Replacement options section with blue icon and "Replace with:" label
  - Addition options section with green icon, "Add:" label, and green border styling

**Verification:**
- npm run build passes

---

## [patterns-005] Handle paired loadouts equipping both items together

**Date:** 2026-01-22

**Decisions:**
- Added `isPairedChoice(unitId, choiceId)` helper function to check if a loadout choice is paired
- Added `getPairedChoiceName(unitId, choiceId)` helper function to get the display name of a paired choice
- Updated `getEquippedWeaponsWithCounts()` to include `isPaired` flag on returned weapons
- The function now tracks paired status from loadout choice data and attaches it to each weapon
- Updated Play Mode weapon display to show paired indicator (⬡) next to weapons from paired loadouts
- The indicator has a tooltip explaining "Paired loadout (equipped together)"
- Paired loadouts work correctly because weapons share a common `loadoutGroup` (e.g., Sentinel Blade melee and ranged both use "blades")
- The Praesidium Shield bonus is modeled as a modifier on the Sentinel Blade weapons, not a separate equipment item
- Selecting a paired choice automatically equips all items in that loadout group together
- Unselecting (setting count to 0) removes all items in that loadout group

**Files changed:**
- `src/main.js` - Added `isPairedChoice(unitId, choiceId)` helper function
- `src/main.js` - Added `getPairedChoiceName(unitId, choiceId)` helper function
- `src/main.js` - Updated `getEquippedWeaponsWithCounts()` to track and return `isPaired` flag
- `index.html` - Added paired indicator (⬡) to Play Mode weapon display with tooltip

**Verification:**
- npm run build passes

---

## [abilities-004] Update stat display to show weapon modifier sources in tooltips

**Date:** 2026-01-22

**Decisions:**
- Added `getModifierSources(unitIndex, stat)` helper function to collect modifier source names with their values
- Function checks three sources of modifiers: unit's enhancement, equipped weapons, and attached leader's enhancement
- Each source is formatted as "Source Name: +/-value" (e.g., "Praesidium Shield: +1" or "Auric Mantle: +2")
- For weapon modifiers, uses the `source` field if present, otherwise falls back to weapon name
- For attached leader enhancements, appends "(Leader)" to distinguish from unit's own enhancement
- Updated Play Mode stat display to show tooltip on modified stats containing all modifier sources
- Added `cursor-help` class to modified stats to indicate they have additional information
- Multiple modifier sources are separated by newlines in the tooltip

**Files changed:**
- `src/main.js` - Added `getModifierSources(unitIndex, stat)` helper function
- `index.html` - Updated Play Mode stat display with `:title` binding showing modifier sources

**Verification:**
- npm run build passes

---

## [leader-008] Hide attached leaders from main army list display

**Date:** 2026-01-22

**Decisions:**
- Added `isUnitAttachedAsLeader(unitIndex)` helper function to check if a unit is attached as a leader to another unit
- Added `getAttachedToUnitName(unitIndex)` helper function to get the name of the unit a leader is attached to
- Updated Play Mode army list to hide units that are attached as leaders using `x-show="!isUnitAttachedAsLeader(index)"`
- Build Mode still shows all units for editing, but attached leaders have visual indicators:
  - Purple left border (border-l-purple-400) and reduced opacity (opacity-75)
  - Badge showing "→ [unit name]" indicating where the leader is attached
- These visual cues help users understand the unit is attached elsewhere while still allowing editing

**Files changed:**
- `src/main.js` - Added `isUnitAttachedAsLeader(unitIndex)` helper function
- `src/main.js` - Added `getAttachedToUnitName(unitIndex)` helper function
- `index.html` - Updated Play Mode army list to hide attached leaders
- `index.html` - Added visual indicator in Build Mode for attached leaders

**Verification:**
- npm run build passes

---

## [abilities-005] Add wargear abilities section to Quick Reference panel

**Date:** 2026-01-22

**Decisions:**
- Added `getWargearAbilities()` helper function that collects unique weapon stat modifiers from faction data
- Function iterates through all units and their weapons to find modifiers with a `source` field
- Each modifier source is displayed once (deduplicated using a Set)
- Added `getStatDisplayName(stat)` helper to convert stat codes to human-readable names (e.g., "w" → "Wounds")
- Description format: "Bearer gains +N StatName." (e.g., "Bearer gains +1 Wounds.")
- Section uses orange color scheme to distinguish from other reference sections
- Section only shows if wargear abilities exist (via `x-if` template conditional)
- Positioned between Detachment Enhancements and Weapon Keywords sections

**Files changed:**
- `src/main.js` - Added `getWargearAbilities()` helper function
- `src/main.js` - Added `getStatDisplayName(stat)` helper function
- `index.html` - Added Wargear Abilities section to Quick Reference panel

**Verification:**
- npm run build passes

---

## [leader-009] Add separate wound tracking for attached leaders

**Date:** 2026-01-22

**Decisions:**
- Added `leaderCurrentWounds` field to the list unit data structure for tracking leader wounds separately
- Field is initialized to `null` when adding new units (same pattern as `currentWounds`)
- Updated `loadList()` to handle missing `leaderCurrentWounds` field on legacy saved lists
- Added 6 new helper functions for leader wound tracking:
  - `getLeaderMaxWounds(unitIndex)` - returns total max wounds for attached leader
  - `getLeaderWoundsPerModel(unitIndex)` - returns wounds per model for attached leader
  - `getLeaderCurrentWounds(unitIndex)` - returns current wounds for attached leader (or max if null)
  - `getLeaderModelsAlive(unitIndex)` - returns number of leader models still alive
  - `getCurrentLeaderModelWounds(unitIndex)` - returns wounds remaining on current leader model
  - `adjustLeaderWounds(unitIndex, delta)` - adjusts leader wounds by delta value
- Updated Damage Tracker UI to show two separate wound pools when a leader is attached:
  - Unit wounds section with gray background, showing unit name and unit-specific controls
  - Leader wounds section with purple border/background, showing leader name and leader-specific controls
- Each wound pool has its own +/- buttons and current model wound indicators
- Total models alive display now sums both unit and leader models alive
- Leader wound indicators use purple color scheme to match other leader UI elements

**Files changed:**
- `src/main.js` - Added `leaderCurrentWounds: null` to unit object in `addUnitToList()`
- `src/main.js` - Added migration logic in `loadList()` for `leaderCurrentWounds` field
- `src/main.js` - Added 6 new leader wound tracking helper functions
- `index.html` - Restructured Damage Tracker UI to show separate unit and leader wound pools
- `CLAUDE.md` - Updated List Unit example with `leaderCurrentWounds` field
- `CLAUDE.md` - Added `leaderCurrentWounds` to List Unit Fields documentation

**Verification:**
- npm run build passes

---

## [mixed-001] Group weapons by loadout choice in Play Mode unit display

**Date:** 2026-01-22

**Decisions:**
- Added `getWeaponsByLoadoutGroup(listUnit)` helper function that groups weapons by their loadoutGroup
- Function returns an array of group objects with: id, name, modelCount, isPaired, and weapons array
- Groups are sorted with _default (Standard Equipment) first, then by model count descending
- Updated Play Mode weapons display to show weapons in distinct visual groups
- Each group has a header showing the model count prefix (e.g., "3×") and the loadout name
- Groups use a subtle background color (bg-gray-600/50) with bottom border to visually separate them
- Paired loadout indicator (⬡) is shown at the group level instead of per-weapon
- This change prepares the UI structure for future features (collapsible groups, ranged/melee sections)

**Files changed:**
- `src/main.js` - Added `getWeaponsByLoadoutGroup(listUnit)` helper function
- `index.html` - Updated Play Mode weapons section to use grouped display with visual separation

**Verification:**
- npm run build passes

---

## [mixed-002] Separate ranged and melee weapon sections within each loadout group

**Date:** 2026-01-22

**Decisions:**
- Updated `getWeaponsByLoadoutGroup(listUnit)` to include separate `rangedWeapons` and `meleeWeapons` arrays
- Each loadout group now returns: id, name, modelCount, isPaired, weapons (all), rangedWeapons, meleeWeapons
- Updated Play Mode UI to display Ranged and Melee subsections within each loadout group
- Ranged subsection has blue color scheme (text-blue-400, border-blue-500/30)
- Melee subsection has red color scheme (text-red-400, border-red-500/30)
- Subsections use left border indent to create visual hierarchy: Loadout > Ranged/Melee > Weapon stats
- Subsections only display if the loadout group has weapons of that type
- This provides clearer organization when loadout groups have both ranged and melee weapons

**Files changed:**
- `src/main.js` - Updated `getWeaponsByLoadoutGroup` to add rangedWeapons and meleeWeapons arrays
- `index.html` - Restructured Play Mode weapons display to show Ranged/Melee subsections

**Verification:**
- npm run build passes

---

## [mixed-003] Make loadout groups collapsible in Play Mode

**Date:** 2026-01-22

**Decisions:**
- Added `collapsedLoadoutGroups` object to `gameState` to track collapsed state per unit and group
- State structure is `{ unitIndex: { groupId: true } }` where true means collapsed
- Added `isLoadoutGroupCollapsed(unitIndex, groupId)` helper function to check if a group is collapsed
- Added `toggleLoadoutGroupCollapsed(unitIndex, groupId)` helper function to toggle collapse state
- Updated Play Mode loadout group UI to make headers clickable with hover effect
- Added chevron icon that rotates 90° when collapsed (points right when collapsed, down when expanded)
- Used Alpine.js `x-collapse` directive for smooth animated transitions
- Collapsed state shows just the header (e.g., "▶ 3× Guardian Spear")
- Expanded state shows the full ranged/melee subsections
- Groups start expanded by default (collapsed state defaults to falsy)

**Files changed:**
- `src/main.js` - Added `collapsedLoadoutGroups` to gameState
- `src/main.js` - Added `isLoadoutGroupCollapsed(unitIndex, groupId)` helper function
- `src/main.js` - Added `toggleLoadoutGroupCollapsed(unitIndex, groupId)` helper function
- `index.html` - Updated loadout group UI with collapsible headers and chevron icons

**Verification:**
- npm run build passes

---

## [mixed-004] Track activation state per loadout group

**Date:** 2026-01-22

**Decisions:**
- Added `activatedLoadoutGroups` object to `gameState` to track which loadout groups have activated this round
- State structure is `{ unitIndex: { groupId: true } }` where true means activated
- Added `isLoadoutGroupActivated(unitIndex, groupId)` helper function to check activation state
- Added `toggleLoadoutGroupActivated(unitIndex, groupId)` helper function to toggle activation
- When a group is marked as activated, it automatically collapses to indicate those models are done
- Added `resetActivationState()` helper function to clear all activation states
- Added `$watch` on `gameState.battleRound` in `init()` to automatically reset activation state when battle round changes
- Visual distinction between collapsed-by-user and collapsed-as-activated:
  - Activated groups have green background (bg-green-900/40) with green ring outline
  - Activated groups show green text colors for model count and loadout name
  - Non-activated groups retain original gray styling
- Added "Act" button on each loadout group header to toggle activation state
- Button shows checkmark (✓) when activated, "Act" when not activated
- Clicking the activate button uses @click.stop to prevent triggering collapse toggle

**Files changed:**
- `src/main.js` - Added `activatedLoadoutGroups` to gameState
- `src/main.js` - Added `isLoadoutGroupActivated(unitIndex, groupId)` helper function
- `src/main.js` - Added `toggleLoadoutGroupActivated(unitIndex, groupId)` helper function
- `src/main.js` - Added `resetActivationState()` helper function
- `src/main.js` - Added `$watch` in init() to reset activation on battle round change
- `index.html` - Updated loadout group styling with conditional classes for activated state
- `index.html` - Added activation toggle button to loadout group headers

**Verification:**
- npm run build passes

---

## [tyranids-001] Create tyranids.json with faction metadata and army rules

**Date:** 2026-01-22

**Decisions:**
- Created new `data/tyranids.json` file with the same structure as `custodes.json`
- Added faction name "Tyranids" and lastUpdated "2026-01"
- Army rules include Synapse with 6" range that gives 3D6 Battle-shock tests
- Army rules include Shadow in the Warp as once-per-battle ability forcing enemy Battle-shock tests
- Both abilities reference SYNAPSE keyword in their rules
- Added `range: 6` to Synapse for potential programmatic use
- Added `oncePerBattle: true` to Shadow in the Warp for tracking
- Added standard weapon keywords section for reference
- Units array starts empty (will be populated by subsequent tasks)
- Detachments object starts empty (will be populated by subsequent tasks)

**Files changed:**
- `data/tyranids.json` - Created new faction data file with:
  - Faction metadata (faction, lastUpdated)
  - armyRules.synapse with name, description, range, keywords
  - armyRules.shadow_in_the_warp with name, description, oncePerBattle, keywords
  - Empty units array placeholder
  - Empty detachments object placeholder
  - weaponKeywords for common abilities
  - Empty allies and glossary placeholders

**Verification:**
- npm run build passes
- JSON validates successfully

---

## [tyranids-003] Add Hormagaunts battleline unit to tyranids.json

**Date:** 2026-01-22

**Decisions:**
- Added Hormagaunts as the second Tyranid battleline unit
- Points costs: 65 points for 10 models, 130 points for 20 models (per Wahapedia/MFM)
- Stats match 10th edition datasheet: M10 T3 SV5+ W1 LD8+ OC2
- No invulnerable save (set to null)
- Only weapon is Hormagaunt Talons (melee): A3 WS4+ S3 AP-1 D1
- No loadout options needed (single weapon profile, no choices)
- Added Bounding Leap ability: eligible to charge after Advancing
- Keywords: Infantry, Battleline, Great Devourer, Endless Multitude, Hormagaunts
- Data sourced from Wahapedia: https://wahapedia.ru/wh40k10ed/factions/tyranids/Hormagaunts

**Files changed:**
- `data/tyranids.json` - Added Hormagaunts unit to the units array with:
  - Full unit stats and points (10 and 20 model options)
  - Hormagaunt Talons melee weapon profile
  - Bounding Leap ability
  - Empty loadoutOptions array (no weapon choices)
  - Appropriate keywords including Battleline and Endless Multitude

**Verification:**
- npm run build passes

---

## [tyranids-002] Add Termagants battleline unit to tyranids.json

**Date:** 2026-01-22

**Decisions:**
- Added Termagants as the first Tyranid battleline unit
- Points costs: 60 points for 10 models, 120 points for 20 models (per Munitorum Field Manual)
- Stats match 10th edition datasheet: M6 T3 SV5+ W1 LD8+ OC2
- No invulnerable save (set to null)
- Included three ranged weapon options via loadoutOptions with "replacement" pattern:
  - Fleshborer (default): 18" A1 BS4+ S5 AP0 D1, Assault
  - Termagant Devourer: 18" A2 BS4+ S4 AP0 D1
  - Termagant Spinefists: 12" A2 BS4+ S3 AP0 D1, Assault, Pistol, Twin-linked
- Included melee weapon: Chitinous Claws and Teeth (A1 WS4+ S3 AP0 D1)
- Added Skulking Horrors ability: reactive D6" move when enemy ends movement within 9"
- Keywords: Infantry, Battleline, Great Devourer, Endless Multitude, Termagants

**Files changed:**
- `data/tyranids.json` - Added Termagants unit to the units array with:
  - Full unit stats and points
  - 4 weapon profiles (3 ranged options, 1 melee)
  - loadoutOptions for ranged weapon replacement choices
  - Skulking Horrors ability
  - Appropriate keywords including Battleline and Endless Multitude

**Verification:**
- npm run build passes

---

## [tyranids-004] Add Genestealers elite unit to tyranids.json

**Date:** 2026-01-22

**Decisions:**
- Added Genestealers as the first Tyranid elite unit
- Points costs: 75 points for 5 models, 140 points for 10 models (per Wahapedia)
- Stats match 10th edition datasheet: M8 T4 SV5+ W2 LD7+ OC1
- Invulnerable save: 5+
- Single weapon: Genestealer Claws and Talons (A4 WS2+ S4 AP-2 D1)
- No loadout options needed (single weapon profile, no choices)
- Added Scouts 8" ability: make a Normal move up to 8" before first turn
- Added Vanguard Predator ability: re-roll 1s to hit, re-roll 1s to wound near objectives
- Keywords: Infantry, Great Devourer, Vanguard Invader, Genestealers
- Data sourced from Wahapedia: https://wahapedia.ru/wh40k10ed/factions/tyranids/Genestealers

**Files changed:**
- `data/tyranids.json` - Added Genestealers unit to the units array with:
  - Full unit stats and points (5 and 10 model options)
  - 5+ invulnerable save
  - Genestealer Claws and Talons melee weapon profile
  - Scouts 8" and Vanguard Predator abilities
  - Empty loadoutOptions array (no weapon choices)
  - Appropriate keywords including Vanguard Invader

**Verification:**
- npm run build passes

---

## [tyranids-005] Add Broodlord character to tyranids.json

**Date:** 2026-01-22

**Decisions:**
- Added Broodlord as the first Tyranid character unit
- Points cost: 80 points for 1 model (per Wahapedia)
- Stats match 10th edition datasheet: M8 T5 SV4+ W6 LD7+ OC1
- Invulnerable save: 4+
- Single weapon: Broodlord Claws and Talons (A5 WS2+ S6 AP-2 D2) with Twin-linked and Devastating Wounds abilities
- No loadout options needed (single weapon profile)
- Added Leader ability with eligibleUnits: ["genestealers"] for leader attachment system
- Added Scouts 8" ability (same as Genestealers)
- Added Hypnotic Gaze (Psychic) ability: -1 to hit for enemy unit in Engagement Range
- Added Vicious Insight ability: grants Devastating Wounds to led unit's weapons
- Keywords: Infantry, Character, Psyker, Great Devourer, Synapse, Vanguard Invader, Broodlord
- Data sourced from Wahapedia: https://wahapedia.ru/wh40k10ed/factions/tyranids/Broodlord

**Files changed:**
- `data/tyranids.json` - Added Broodlord unit to the units array with:
  - Full unit stats and points (1 model option)
  - 4+ invulnerable save
  - Broodlord Claws and Talons melee weapon profile with Twin-linked and Devastating Wounds
  - Leader ability with eligibleUnits for Genestealers
  - Scouts 8", Hypnotic Gaze, and Vicious Insight abilities
  - Empty loadoutOptions array (no weapon choices)
  - Appropriate keywords including Character, Psyker, and Synapse

**Verification:**
- npm run build passes

---

## [tyranids-006] Add Tyranid Warriors unit to tyranids.json

**Date:** 2026-01-22

**Decisions:**
- Added Tyranid Warriors as the first Synapse infantry unit (non-character)
- Points costs: 65 points for 3 models, 130 points for 6 models (per Wahapedia - Ranged Bio-weapons variant)
- Stats match 10th edition datasheet: M6 T5 SV4+ W3 LD7+ OC2
- No invulnerable save
- Multiple ranged weapon options via loadoutOptions:
  - Devourer (default): 18" A5 BS4+ S4 AP0 D1
  - Deathspitter: 24" A3 BS4+ S5 AP-1 D1
  - Spinefists: 12" A2 BS4+ S4 AP0 D1 (Assault, Pistol, Twin-linked)
- Heavy weapon options as "addition" pattern (max 2 per unit - "for every 3 models"):
  - Barbed Strangler: 36" D6+1 BS4+ S6 AP-1 D1 (Blast)
  - Venom Cannon: 36" D3 BS4+ S9 AP-2 D2 (Blast)
- Scything Talons melee weapon: A5 WS3+ S5 AP-1 D1
- Added Adaptable Predators ability: eligible to shoot and charge after Falling Back
- Added Shadow in the Warp/Synapse ability reference
- Keywords: Infantry, Great Devourer, Synapse, Tyranid Warriors
- Data sourced from Wahapedia: https://wahapedia.ru/wh40k10ed/factions/tyranids/Tyranid-Warriors-With-Ranged-Bio-weapons

**Files changed:**
- `data/tyranids.json` - Added Tyranid Warriors unit to the units array with:
  - Full unit stats and points (3 and 6 model options)
  - 6 weapon profiles (5 ranged options in loadoutOptions, 1 melee)
  - loadoutOptions for ranged weapon replacement and heavy weapon addition choices
  - Adaptable Predators and Synapse abilities
  - Appropriate keywords including Synapse

**Verification:**
- npm run build passes
- JSON validates successfully

---

## [tyranids-007] Add Hive Tyrant monster to tyranids.json

**Date:** 2026-01-22

**Decisions:**
- Added Hive Tyrant as the first Tyranid monster unit (and first with T10+)
- Points cost: 195 points for 1 model (per Wahapedia)
- Stats match 10th edition datasheet: M8 T10 SV2+ W10 LD7+ OC3
- Invulnerable save: 4+
- Ranged weapon options via loadoutOptions (replacement pattern):
  - Heavy Venom Cannon (default): 36" D3 BS2+ S9 AP-2 D3 (Blast)
  - Stranglethorn Cannon: 36" D6+1 BS2+ S7 AP-1 D2 (Blast)
- Melee weapon options via loadoutOptions (replacement pattern):
  - Monstrous Bonesword and Lash Whip (default): A6 WS2+ S9 AP-2 D3 (Twin-linked)
  - Monstrous Scything Talons: A4 WS2+ S7 AP-2 D2 (Extra Attacks)
- Added Leader ability with eligibleUnits: ["tyrant-guard"] (Tyrant Guard unit to be added later)
- Added Deadly Demise D3 ability
- Added Will of the Hive Mind ability: 1CP reduction for friendly units within 12"
- Added Onslaught (Aura, Psychic) ability: grants Assault and Lethal Hits to nearby units
- Keywords: Monster, Character, Psyker, Great Devourer, Synapse, Hive Tyrant
- Data sourced from Wahapedia: https://wahapedia.ru/wh40k10ed/factions/tyranids/Hive-Tyrant

**Files changed:**
- `data/tyranids.json` - Added Hive Tyrant unit to the units array with:
  - Full unit stats and points (1 model option)
  - 4+ invulnerable save
  - 4 weapon profiles (2 ranged options, 2 melee options)
  - loadoutOptions for ranged and melee weapon replacement choices
  - Leader ability with eligibleUnits for Tyrant Guard
  - Deadly Demise D3, Will of the Hive Mind, and Onslaught abilities
  - Appropriate keywords including Monster, Character, Psyker, and Synapse

**Verification:**
- npm run build passes

---

## [tyranids-008] Add Carnifexes monster unit to tyranids.json

**Date:** 2026-01-22

**Decisions:**
- Added Carnifexes as the second Tyranid monster unit
- Points costs: 90 points for 1 model, 180 points for 2 models (per Wahapedia)
- Stats match 10th edition datasheet: M8 T9 SV2+ W8 LD8+ OC3
- No invulnerable save (set to null)
- Extensive weapon loadout options modeled as left-arm/right-arm replacement choices:
  - Left arm options: Scything Talons (default), Crushing Claws, Deathspitters, Devourers
  - Right arm options: Same as left arm plus Heavy Venom Cannon and Stranglethorn Cannon
- Addition pattern options for extra weapons:
  - Additional weapons: Bio-plasma, Spine Banks
  - Extra Scything Talons: Can add +2 attacks if taking an extra set of talons
- Ranged weapon profiles:
  - Bio-plasma: 12" D3 BS4+ S7 AP-2 D1 (Assault, Blast)
  - Deathspitters with Slimer Maggots: 24" A6 BS4+ S7 AP-2 D1 (Assault)
  - Devourers with Brainleech Worms: 18" A12 BS4+ S6 AP0 D1 (Assault)
  - Heavy Venom Cannon: 36" D3 BS4+ S9 AP-2 D3 (Blast)
  - Stranglethorn Cannon: 36" D6+1 BS4+ S7 AP-1 D2 (Blast)
  - Spine Banks: 6" A5 BS4+ S5 AP0 D1 (Assault)
- Melee weapon profiles:
  - Carnifex Crushing Claws: A4 WS4+ S12 AP-3 D6+1
  - Carnifex Scything Talons: A6 WS4+ S9 AP-2 D3
  - Carnifex Extra Scything Talons: A2 WS4+ S9 AP-2 D3 (Extra Attacks)
  - Chitinous Claws and Teeth: A4 WS4+ S6 AP0 D1 (default melee)
- Added Deadly Demise 1 ability
- Added Blistering Assault ability: D6+2" move when shooting if not in Engagement Range (but cannot shoot)
- Keywords: Monster, Great Devourer, Carnifexes
- Data sourced from Wahapedia: https://wahapedia.ru/wh40k10ed/factions/tyranids/Carnifexes

**Files changed:**
- `data/tyranids.json` - Added Carnifexes unit to the units array with:
  - Full unit stats and points (1 and 2 model options)
  - 10 weapon profiles (6 ranged options, 4 melee options)
  - 4 loadoutOptions for left-arm, right-arm, additional weapons, and extra talons
  - Deadly Demise 1 and Blistering Assault abilities
  - Appropriate keywords including Monster and Great Devourer

**Verification:**
- npm run build passes

---

## [tyranids-009] Add Invasion Fleet detachment to tyranids.json

**Date:** 2026-01-22

**Decisions:**
- Added Invasion Fleet as the first Tyranid detachment
- Detachment rule is Hyper-adaptations with a "selection" type and three adaptation choices
- Swarming Instincts: Sustained Hits 1 vs Infantry/Swarm
- Hyper-aggression: Lethal Hits vs Monster/Vehicle
- Hive Predators: Critical Hits auto-wound and gain Precision vs Characters
- Added all 6 stratagems with appropriate phases and CP costs:
  - Rapid Regeneration (1CP): Feel No Pain 6+/5+ based on Synapse Range
  - Adrenal Surge (2CP): Critical Hits on 5+ in melee
  - Death Frenzy (1CP): Fight when destroyed on 4+
  - Overrun (1CP): Extended Consolidation or Normal Move if in Synapse Range
  - Predatory Imperative (1CP): Gain additional Hyper-adaptation
  - Endless Swarm (1CP): Return D3+3 models to Endless Multitude units
- Added all 4 enhancements with accurate points costs:
  - Alien Cunning (30pts): Redeploy up to 3 units after deployment
  - Perfectly Adapted (15pts): Once per turn re-roll
  - Synaptic Linchpin (20pts): Extend Synapse Range to 9"
  - Adaptive Biology (25pts): Feel No Pain 5+, upgrades to 4+ after taking wounds
- Data sourced from Wahapedia: https://wahapedia.ru/wh40k10ed/factions/tyranids/

**Files changed:**
- `data/tyranids.json` - Added invasion_fleet detachment with:
  - Hyper-adaptations rule with three choices
  - 6 stratagems (Rapid Regeneration, Adrenal Surge, Death Frenzy, Overrun, Predatory Imperative, Endless Swarm)
  - 4 enhancements (Alien Cunning, Perfectly Adapted, Synaptic Linchpin, Adaptive Biology)

**Verification:**
- npm run build passes

---

## [tyranids-010] Add Unending Swarm detachment to tyranids.json

**Date:** 2026-01-22

**Decisions:**
- Added Unending Swarm as the second Tyranid detachment
- Detachment rule is Insurmountable Odds with passive Surge move mechanic
- Surge moves trigger after ENDLESS MULTITUDE units lose models to shooting
- Roll 1D6 and move up to that distance toward closest enemy (can enter Engagement Range)
- Added all 6 stratagems with appropriate phases and CP costs:
  - Swarming Masses (1CP): Sustained Hits 1, or Sustained Hits 2 with 15+ models
  - Teeming Masses (1CP): -1 to hit against target ENDLESS MULTITUDE unit
  - Preservation Imperative (1CP): Unit counts as <5 models for Blast purposes
  - Synaptic Goading (1CP): Re-roll Surge move, can move toward objective instead
  - Unending Waves (2CP): Return destroyed ENDLESS MULTITUDE unit to Strategic Reserves
  - Bounding Advance (1CP): Auto +6" to Move when Advancing instead of rolling
- Added all 4 enhancements with accurate points costs:
  - Relentless Hunger (20pts): +2" to Move for bearer's unit (includes modifier)
  - Naturalised Camouflage (30pts): Up to 3 ENDLESS MULTITUDE units get Benefit of Cover round 1
  - Piercing Talons (25pts): Critical Wounds improve AP by 1
  - Adrenalised Onslaught (15pts): +3" to Pile In and Consolidate moves
- Data sourced from Wahapedia: https://wahapedia.ru/wh40k10ed/factions/tyranids/

**Files changed:**
- `data/tyranids.json` - Added unending_swarm detachment with:
  - Insurmountable Odds rule with Surge move mechanic
  - 6 stratagems (Swarming Masses, Teeming Masses, Preservation Imperative, Synaptic Goading, Unending Waves, Bounding Advance)
  - 4 enhancements (Relentless Hunger, Naturalised Camouflage, Piercing Talons, Adrenalised Onslaught)

**Verification:**
- npm run build passes

---

## [tyranids-011] Add Crusher Stampede detachment to tyranids.json

**Date:** 2026-01-22

**Decisions:**
- Added Crusher Stampede as the third Tyranid detachment
- Detachment rule is Enraged Behemoths with bonuses based on Monster strength level:
  - At Starting Strength: +2 Objective Control (excludes Battle-shocked units)
  - Below Starting Strength: +1 to Hit rolls
  - Below Half-strength: +1 to Hit rolls AND +1 to Wound rolls
- Added structured `bonuses` array to the rule to document the three condition tiers
- Added all 6 stratagems with appropriate phases and CP costs:
  - Corrosive Viscera (1CP): Auto-trigger Deadly Demise instead of rolling
  - Rampaging Monstrosities (1CP): Re-roll Hit rolls in Fight phase
  - Savage Roar (1CP): Force Battle-shock test on attacking enemy, -1 to hit
  - Untrammelled Ferocity (1CP): Move through models and terrain in Movement phase
  - Swarm-guided Salvoes (1CP): Ignores Cover and ignore BS modifiers
  - Massive Impact (1CP): Roll 6D6 on charge, mortal wounds on 4+
- Added all 4 enhancements with accurate points costs:
  - Ominous Presence (15pts): +3 OC, includes stat modifier
  - Enraged Reserves (20pts): Fight on death on 3+
  - Null Nodules (10pts): Feel No Pain 5+ vs Psychic once per battle
  - Monstrous Nemesis (25pts): +1 to Wound vs Monster/Vehicle
- Data sourced from Wahapedia: https://wahapedia.ru/wh40k10ed/factions/tyranids/

**Files changed:**
- `data/tyranids.json` - Added crusher_stampede detachment with:
  - Enraged Behemoths rule with bonuses array documenting strength-based effects
  - 6 stratagems (Corrosive Viscera, Rampaging Monstrosities, Savage Roar, Untrammelled Ferocity, Swarm-guided Salvoes, Massive Impact)
  - 4 enhancements (Ominous Presence, Enraged Reserves, Null Nodules, Monstrous Nemesis)

**Verification:**
- npm run build passes

